services:
  mariadb:
    image: mariadb:11
    restart: always
    environment:
      MARIADB_ROOT_PASSWORD: rootpassword
      MARIADB_USER: myuser
      MARIADB_PASSWORD: mypassword
    ports:
      - "3306:3306"
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./init-scripts:/docker-entrypoint-initdb.d
    networks:
      - backend

  iam_apiservice:
    build:
      context: .
      dockerfile: AttrectoTest.IamService/Dockerfile
    ports:
      - "5002:8081" # http
      - "5102:8080" # gRpc
    depends_on:
      - mariadb
    environment:
      - ConnectionStrings__DefaultConnection=Server=mariadb;Port=3306;Database=attrecto_iam;User=myuser;Password=mypassword;
    networks:
      - backend

  feed_apiservice:
    build:
      context: .
      dockerfile: AttrectoTest.ApiService/Dockerfile
    ports:
      - "5001:8080"
    depends_on:
      - mariadb
      - iam_apiservice
    environment:
      - ConnectionStrings__DefaultConnection=Server=mariadb;Port=3306;Database=attrecto_feed;User=myuser;Password=mypassword;
      - ApiSettings__AimBaseUrl=http://iam_apiservice:8080
    networks:
      - backend
      
  webfrontend:
    build: ./WebApp/attrectoweb
    depends_on:
      - feed_apiservice
    ports:
      - "3001:80"
    networks:
      - backend
      
networks:
  backend:

volumes:
  mariadb_data:
